<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Brett Lischalk | Practical Malware Analysis: Lab 3-2</title>
  <meta name="description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 3-2 malware.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Practical Malware Analysis: Lab 3-2">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://brettlischalk.com//posts/practical-malware-analysis-lab-3-2">
  <meta property="og:description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 3-2 malware.">
  <meta property="og:site_name" content="Brett Lischalk">
  <meta property="og:image" content="http://brettlischalk.com//assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://brettlischalk.com//posts/practical-malware-analysis-lab-3-2">
  <meta name="twitter:title" content="Practical Malware Analysis: Lab 3-2">
  <meta name="twitter:description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 3-2 malware.">
  <meta name="twitter:image" content="http://brettlischalk.com//assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://brettlischalk.com//feed.xml" type="application/rss+xml" rel="alternate" title="Brett Lischalk Last 10 blog posts" />

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6246123062809579",
      enable_page_level_ads: true
    });
  </script>

  
    <link type="text/css" rel="stylesheet" href="/assets/dark.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="Brett Lischalk">Brett Lischalk</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <span class="icon icon-android-person"></span>
        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/blischalk" target="_blank" title="Twitter">
          <span class="icon icon-social-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/blischalk" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/brett-lischalk-3104537" target="_blank" title="LinkedIn">
          <span class="icon icon-social-linkedin"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="mailto:brett@brettlischalk.com" target="_blank" title="Email">
          <span class="icon icon-at"></span>
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>Practical Malware Analysis: Lab 3-2</h1>
            <div class="article-list-footer">
              <span class="article-list-date">
                December 31, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  5 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/malware">malware</a>
                
                  <a href="/tag/analysis">analysis</a>
                
                  <a href="/tag/practical-malware-analysis">practical-malware-analysis</a>
                
                  <a href="/tag/reverse-engineering">reverse-engineering</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>This is my analysis of the malware for Lab03-02 from the Practical
Malware Analysis book exercises.</p>

<h2 id="overview">Overview</h2>

<p>For Lab03-02 we must analyze the malware found in the file
<code class="highlighter-rouge">Lab03-02.dll</code> using basic dynamic analysis tools.</p>

<p>The following are the tasks required to complete the lab exercise:</p>

<h2 id="analysis">Analysis</h2>

<h2 id="basic-analysis">Basic Analysis</h2>

<p>Before performing any dynamic analysis we want to see what sort of
information can be gathered without having to run the malware first.</p>

<h3 id="strings">Strings</h3>

<p>Looking at the strings this malware contains reveals:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">strings Lab03-02.dll

<span class="o">!</span>This program cannot be run <span class="k">in </span>DOS mode.
.. snip ..
GetProcAddress
LoadLibraryA
RegisterServiceCtrlHandlerA
RegSetValueExA
RegCreateKeyA
CloseServiceHandle
CreateServiceA
OpenSCManagerA
RegCloseKey
RegQueryValueExA
RegOpenKeyExA
DeleteService
OpenServiceA
SetServiceStatus
ADVAPI32.dll
WSASocketA
WS2_32.dll
InternetReadFile
HttpQueryInfoA
HttpSendRequestA
HttpOpenRequestA
InternetConnectA
InternetOpenA
InternetCloseHandle
WININET.dll
Lab03-02.dll
Install
ServiceMain
UninstallService
installA
uninstallA
<span class="nv">Y29ubmVjdA</span><span class="o">==</span>
practicalmalwareanalysis.com
serve.html
 Windows XP 6.11
CreateProcessA
kernel32.dll
HTTP/1.1
DependOnService
RpcSs
ServiceDll
Depends INA+, Collects and stores network configuration and location information
, and notifies applications when this information changes.
ImagePath
%SystemRoot%<span class="se">\S</span>ystem32<span class="se">\s</span>vchost.exe <span class="nt">-k</span>
SYSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\</span>
CreateService<span class="o">(</span>%s<span class="o">)</span> error %d
Intranet Network Awareness <span class="o">(</span>INA+<span class="o">)</span>
%SystemRoot%<span class="se">\S</span>ystem32<span class="se">\s</span>vchost.exe <span class="nt">-k</span> netsvcs
OpenSCManager<span class="o">()</span>
You specify service name not <span class="k">in </span>Svchost//netsvcs, must be one of following:
RegQueryValueEx<span class="o">(</span>Svchost<span class="se">\n</span>etsvcs<span class="o">)</span>
netsvcs
RegOpenKeyEx<span class="o">(</span>%s<span class="o">)</span> KEY_QUERY_VALUE success.
RegOpenKeyEx<span class="o">(</span>%s<span class="o">)</span> KEY_QUERY_VALUE error <span class="nb">.</span>
SOFTWARE<span class="se">\M</span>icrosoft<span class="se">\W</span>indows NT<span class="se">\C</span>urrentVersion<span class="se">\S</span>vchost
IPRIP
uninstall success
OpenService<span class="o">(</span>%s<span class="o">)</span> error 2
OpenService<span class="o">(</span>%s<span class="o">)</span> error 1
uninstall is starting
.?AVtype_info@@

.. snip ..</code></pre></figure>

<p>Of particular interest are:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">practicalmalwareanalysis.com
RegSetValueExA
RegCreateKeyA
CloseServiceHandle
CreateServiceA
RegCloseKey
RegQueryValueExA
RegOpenKeyExA
DeleteService
OpenServiceA
SetServiceStatus
InternetReadFile
HttpQueryInfoA
HttpSendRequestA
HttpOpenRequestA
InternetConnectA
InternetOpenA
InternetCloseHandle
SOFTWARE<span class="se">\M</span>icrosoft<span class="se">\W</span>indows NT<span class="se">\C</span>urrentVersion<span class="se">\S</span>vchost
IPRIP</code></pre></figure>

<p>Based on the strings we see, it appears that the malware will most
likely attempt to make an internet connection to
<code class="highlighter-rouge">practicalmalwareanalysis.com</code>. It also appears that this malware
modifies the registry and installs a service.</p>

<h2 id="lab-questions">Lab Questions</h2>

<h3 id="how-can-you-get-this-malware-to-install-itself">How can you get this malware to install itself?</h3>

<p>Since this malware is a Windows DLL we have a couple of options for how
we can get it to install itself. We can either utilize <code class="highlighter-rouge">rundll32.exe</code>
which is provided by Windows or we can attempt to modify the DLL PE
header and change its extension to force Windows to load the DLL as
it would an executable. Let’s try the former.</p>

<p>To utilize <code class="highlighter-rouge">rundll32.exe</code> we will need to know the name of the DLL we
wan to analyze and the function name or ordinal of an exported
function. Utilizing IDA Pro we can see what functions the DLL
exports. Reviewing the exports we see a function called <code class="highlighter-rouge">installA</code>.:</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-02-dll-idapro-exports.png" alt="Lab03-02.dll in IDAPro" /></p>

<p>Before attempting to run the DLL, we will want to do a bit of
preparation. We will:</p>

<ul>
  <li>Take a snapshot of the registry with <code class="highlighter-rouge">RegShot</code></li>
  <li>Setup <code class="highlighter-rouge">ApateDNS</code> to look for DNS requests</li>
  <li>Setup <code class="highlighter-rouge">Process Explorer</code> to monitor the processes on the system</li>
  <li>Take a snapshot of the VirtualBox VM to revert</li>
</ul>

<p>We proceed to attempt to install the malware with <code class="highlighter-rouge">rundll32.exe
Lab03-02.dll installA</code>. After installation another registry snapshot
is taken and a comparison made. The comparison yields:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nt">----------------------------------</span>
Keys added: 9
<span class="nt">----------------------------------</span>
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\P</span>arameters
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\S</span>ecurity
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\I</span>PRIP
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\P</span>arameters
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\S</span>ecurity
HKU<span class="se">\S</span><span class="nt">-1-5-21-2025429265-1708537768-1060284298-1003</span><span class="se">\S</span>oftware<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\E</span>xplorer<span class="se">\C</span>omDlg32<span class="se">\O</span>penSaveMRU<span class="se">\h</span>ivu
HKU<span class="se">\S</span><span class="nt">-1-5-21-2025429265-1708537768-1060284298-1003</span><span class="se">\S</span>oftware<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\E</span>xplorer<span class="se">\F</span>ileExts<span class="se">\.</span>hivu
HKU<span class="se">\S</span><span class="nt">-1-5-21-2025429265-1708537768-1060284298-1003</span><span class="se">\S</span>oftware<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\E</span>xplorer<span class="se">\F</span>ileExts<span class="se">\.</span>hivu<span class="se">\O</span>penWithList

<span class="nt">----------------------------------</span>
Values added: 37
<span class="nt">----------------------------------</span>
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\T</span>ype: 0x00000020
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\S</span>tart: 0x00000002
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\E</span>rrorControl: 0x00000001
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\I</span>magePath: <span class="s2">"%SystemRoot%</span><span class="se">\S</span><span class="s2">ystem32</span><span class="se">\s</span><span class="s2">vchost.exe -k netsvcs"</span>
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\D</span>isplayName: <span class="s2">"Intranet Network Awareness (INA+)"</span>
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\O</span>bjectName: <span class="s2">"LocalSystem"</span>
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\D</span>escription: <span class="s2">"Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes."</span>
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\D</span>ependOnService:  52 00 70 00 63 00 53 00 73 00 00 00 00 00
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\P</span>arameters<span class="se">\S</span>erviceDll: <span class="s2">"C:</span><span class="se">\D</span><span class="s2">ocuments and Settings</span><span class="se">\B</span><span class="s2">rett Lischalk</span><span class="se">\D</span><span class="s2">esktop</span><span class="se">\P</span><span class="s2">ractical Malware Analysis Labs</span><span class="se">\B</span><span class="s2">inaryCollection</span><span class="se">\C</span><span class="s2">hapter_3L</span><span class="se">\L</span><span class="s2">ab03-02.dll"</span>
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>ontrolSet001<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\S</span>ecurity<span class="se">\S</span>ecurity:  01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\T</span>ype: 0x00000020
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\S</span>tart: 0x00000002
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\E</span>rrorControl: 0x00000001
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\I</span>magePath: <span class="s2">"%SystemRoot%</span><span class="se">\S</span><span class="s2">ystem32</span><span class="se">\s</span><span class="s2">vchost.exe -k netsvcs"</span>
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\D</span>isplayName: <span class="s2">"Intranet Network Awareness (INA+)"</span>
HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\I</span>PRIP<span class="se">\O</span>bjectName: <span class="s2">"LocalSystem"</span></code></pre></figure>

<p>This seems to indicate that the malware has been installed successfully.</p>

<h3 id="how-would-you-get-this-malware-to-run-after-instalation">How would you get this malware to run after instalation?</h3>

<p>We can see that a new service called <code class="highlighter-rouge">IPRIP</code> has had registry entries
added for it. Since we know the service name we may now attempt to
start the service and begin dynamic analysis. We can attempt to
start the service using:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">net start IPRIP</code></pre></figure>

<p>Looking at <code class="highlighter-rouge">ApateDNS</code> it indicates that the malware did attempt to
make a connection to <code class="highlighter-rouge">practicalmalwareanalysis.com</code>. It appears that
we have successfully run the installed malware.</p>

<h3 id="how-can-you-find-the-process-under-which-this-malware-is-running">How can you find the process under which this malware is running?</h3>

<p>After starting the service we do a search for <code class="highlighter-rouge">Lab03-02.dll</code> in
<code class="highlighter-rouge">Process Explorer</code>. We can see in process explorer that Lab03-02.dll
has been loaded into <code class="highlighter-rouge">svchost.exe</code> with pid 1048.</p>

<h3 id="which-filters-could-you-set-in-order-to-use-procmon-to-glean-information">Which filters could you set in order to use procmon to glean information?</h3>

<p>In procmon the pid can be used as the filter.</p>

<h3 id="what-are-the-malwares-host-based-indicators">What are the malware’s host-based indicators?</h3>

<p>The malware installs a service called IPRIP. It has a display name of
Intranet Network Awareness (INA+). It’s description is, “Depends INA+,
Collects and stores network configuration and location information ,
and notifies applications when this information changes.”</p>

<p>It writes:
<code class="highlighter-rouge">HKLM\SYSTEM\ControlSet001\Services\IPRIP\Parameters\ServiceDll:
%CurrentDirectory%\Lab03-02.dll</code> in the registry for persistence.</p>

<h3 id="are-there-any-useful-network-based-signatures-for-this-malware">Are there any useful network-based signatures for this malware?</h3>

<p>It attempts to do a GET request to
practicalmalwareanalysis.com/serve.html over port 80 with User-Agent:</p>

<p><code class="highlighter-rouge">%ComputerName% Windows XP 6.11</code></p>

          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=Practical Malware Analysis: Lab 3-2 - http://brettlischalk.com//posts/practical-malware-analysis-lab-3-2 by @blischalk', 'newwindow', 'width=500, height=225'); return false;">
              <span class="icon icon-social-twitter"></span>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://brettlischalk.com//posts/practical-malware-analysis-lab-3-2', 'newwindow', 'width=500, height=500'); return false;">
              <span class="icon icon-social-facebook"></span>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=http://brettlischalk.com//posts/practical-malware-analysis-lab-3-2', 'newwindow', 'width=550, height=400'); return false;">
              <span class="icon icon-social-googleplus"></span>
            </a>
          </div>

          <a href="https://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/" title="Offensive Security Certified Professional" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-oscp.png" />
          </a>
          <a href="https://www.offensive-security.com/information-security-certifications/osce-offensive-security-certified-expert/" title="Offensive Security Certified Expert" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-osce.png"" />
          </a>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script>
              (function() {
                  var d = document, s = d.createElement('script');
                  s.src = '//blischalkblog.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
        </article>
        <footer class="footer reveal">
  <p>
    Site content by: <a href="/about" title="About me">Brett Lischalk</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  <script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>


  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-4121143-2','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>


</body>
</html>
