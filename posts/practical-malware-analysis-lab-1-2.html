<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Brett Lischalk | Practical Malware Analysis: Lab 1-2</title>
  <meta name="description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 1-2 malware.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Practical Malware Analysis: Lab 1-2">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://localhost:4000/posts/practical-malware-analysis-lab-1-2">
  <meta property="og:description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 1-2 malware.">
  <meta property="og:site_name" content="Brett Lischalk">
  <meta property="og:image" content="http://localhost:4000/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://localhost:4000/posts/practical-malware-analysis-lab-1-2">
  <meta name="twitter:title" content="Practical Malware Analysis: Lab 1-2">
  <meta name="twitter:description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 1-2 malware.">
  <meta name="twitter:image" content="http://localhost:4000/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://localhost:4000/feed.xml" type="application/rss+xml" rel="alternate" title="Brett Lischalk Last 10 blog posts" />

  
    <link type="text/css" rel="stylesheet" href="/assets/dark.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="Brett Lischalk">Brett Lischalk</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <span class="icon icon-android-person"></span>
        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/blischalk" target="_blank" title="Twitter">
          <span class="icon icon-social-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/blischalk" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/brett-lischalk-3104537" target="_blank" title="LinkedIn">
          <span class="icon icon-social-linkedin"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="mailto:brett@brettlischalk.com" target="_blank" title="Email">
          <span class="icon icon-at"></span>
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>Practical Malware Analysis: Lab 1-2</h1>
            <div class="article-list-footer">
              <span class="article-list-date">
                August 24, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  4 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/malware">malware</a>
                
                  <a href="/tag/analysis">analysis</a>
                
                  <a href="/tag/practical-malware-analysis">practical-malware-analysis</a>
                
                  <a href="/tag/reverse-engineering">reverse-engineering</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>This is my analysis of the malware for Lab01-02 from the Practical
Malware Analysis book exercises.</p>

<h2 id="overview">Overview</h2>

<p>The Lab 1-2 malware that is to be analyized using basic static
analysis techniques consists of the file <code class="highlighter-rouge">Lab01-02.exe</code>.</p>

<p>The following are the tasks required to complete the lab exercise:</p>

<h2 id="basic-static-analysis">Basic Static Analysis</h2>

<h3 id="virustotal">VirusTotal?</h3>

<p>Upload the Lab01-02.exe file to
<a href="http://www.virustotal.com">http://www.virustotal.com</a>. Does it match
any existing antivirus definitions?</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-02-exe-virus-total.png" alt="Lab01-02.exe Virus Total" /></p>

<p>According to VirutTotal this malware has been seen before.</p>

<h3 id="packed-or-obfuscated">Packed or Obfuscated?</h3>

<p>Are there any indications that this file is packed or obfuscated? If
so, what are these indicators? If the file is packed, unpack it if
possible.</p>

<p>We can gain some insight as to if the malware is packed or obfuscated
in any way using <code class="highlighter-rouge">strings</code>, <code class="highlighter-rouge">PEid</code>, <code class="highlighter-rouge">PEView</code>, and <code class="highlighter-rouge">IDAPro</code>.</p>

<h4 id="strings">Strings</h4>

<p>Using the <code class="highlighter-rouge">strings</code> utility on <code class="highlighter-rouge">Lab01-02.exe</code> we see the following:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">.. snip ..

KERNEL32.DLL
ADVAPI32.dll
MSVCRT.dll
WININET.dll
LoadLibraryA
GetProcAddress
VirtualProtect
VirtualAlloc
VirtualFree
ExitProcess
CreateServiceA
<span class="nb">exit
</span>InternetOpenA</code></pre></figure>

<p>The strings that are found don’t give away much about the
functionality of the malware. From what was learned in the Practical
Malware Analysis book, a malware that has few strings and has
<code class="highlighter-rouge">LoadLibary</code> and <code class="highlighter-rouge">GetProcAddress</code> points to a high likelyhood that the
malware is packed. We can gain more insight using <code class="highlighter-rouge">PEid</code>.</p>

<h4 id="peid">PEid</h4>

<p>When running PEid it doesn’t find the usage of a specific packer but the “EP Section” shows UPX1 which seems to point at the usage of a packer.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-02-exe-peid.png" alt="Lab01-02.exe PEid" /></p>

<p>We can get more information using PEView.</p>

<h4 id="peview">PEView</h4>

<p>Looking at the executable in PEView reveals some interesting things
that hint at packer use. The sections are called: UPX0, UPX1, and
UPX2. Sections of an exeuctable would normally include sections neamed
like: “.text”, “.rdata”, and “.data”. The headers of the sections show
that the “Virtual Size” is different than the “Raw Data” size. This
means that the section takes more space in memory than on disk. This
is another indication of packer usage.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-02-exe-peview.png" alt="Lab01-02.exe PEview" /></p>

<h4 id="idapro">IDAPro</h4>

<p>Finally, simply opening the executable in IDAPro warns that this
executable seems to be packed or obfuscated:</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-02-exe-idapro-1.png" alt="Lab01-02.exe IDAPro 1" /></p>

<p>Proceeding to open the executable anyways shows that the imports list
of imports is quite small just like we saw in the usage of Strings.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-02-exe-idapro-2.png" alt="Lab01-02.exe IDAPro 2" /></p>

<h4 id="upacking">Upacking</h4>

<p>At this point it if fairly safe to assume that this executable is
packed using the UPX packer. We can unpack the executable using:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">PS C:<span class="se">\U</span>sers<span class="se">\B</span>rett<span class="se">\D</span>esktop<span class="se">\P</span>ractical Malware Analysis Labs<span class="se">\B</span>inaryCollection<span class="se">\C</span>hapter_1L&gt; upx -d Lab01-02.exe
                       Ultimate Packer <span class="k">for </span>eXecutables
                          Copyright <span class="o">(</span>C<span class="o">)</span> 1996 - 2013
UPX 3.91w       Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Sep 30th 2013

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
     16384 &lt;-      3072   18.75%    win32/pe     Lab01-02.exe

Unpacked 1 file.</code></pre></figure>

<p>Now that the executable is unpacked, opening it in IDAPro gives us a
different story:</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-02-exe-idapro-3.png" alt="Lab01-02.exe IDAPro 3" /></p>

<p>The list of imports has expanded to include many more functions.</p>

<h3 id="imports-hint-at-functionality">Imports Hint at Functionality?</h3>

<p>Do any imports hint at this program’s functionality? If so, which
imports are they and what do they tell you?</p>

<p>Some of the interesting imports that can be found are:</p>

<ul>
  <li>CreateServiceA</li>
  <li>StartServiceCtrlDispatcherA</li>
  <li>OpenSCManager</li>
  <li>InternetOpenUrlA</li>
  <li>InternetOpenUrl</li>
</ul>

<p>Based on these imports it seems that this malware sets up a Windows
service. The malware also appears to reach out to a url.</p>

<h3 id="host--or-network-based-indicators">Host- or Network-Based Indicators?</h3>

<p>What host- or network-based indicators could be used to identify this
malware on infected machines?</p>

<p>Looking at the <code class="highlighter-rouge">strings</code> output after the unpacking of the executable
the following strings can be found:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">InternetOpenUrlA
InternetOpenA
MalService
Malservice
HGL345
http://www.malwareanalysisbook.com
Internet Explorer 8.0</code></pre></figure>

<p>“MalService” seems likely to be the name of the service that would be
running on the host. If “MalService” was found in the service list
this would be a host-based indicator that the host was infected with
the malware.</p>

<p>If network activity was detected going to
“http://www.malwareanalysisbook.com”, this would be a strong
network-based indicator that the malware was present on the system.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This concludes the analysis of the second malware of Lab 1 from the
Practical Malware Analysis book. The techniques utilized where very
similar to the techniques needed for the first malware sample with the
twist of dealing with a packed malware sample. It will be interesting
to see what new twist the next malware may have.</p>

          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=Practical Malware Analysis: Lab 1-2 - http://localhost:4000/posts/practical-malware-analysis-lab-1-2 by @blischalk', 'newwindow', 'width=500, height=225'); return false;">
              <span class="icon icon-social-twitter"></span>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/posts/practical-malware-analysis-lab-1-2', 'newwindow', 'width=500, height=500'); return false;">
              <span class="icon icon-social-facebook"></span>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=http://localhost:4000/posts/practical-malware-analysis-lab-1-2', 'newwindow', 'width=550, height=400'); return false;">
              <span class="icon icon-social-googleplus"></span>
            </a>
          </div>

          <a href="https://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/" title="Offensive Security Certified Professional" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-oscp.png" />
          </a>
          <a href="https://www.offensive-security.com/information-security-certifications/osce-offensive-security-certified-expert/" title="Offensive Security Certified Expert" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-osce.png"" />
          </a>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script>
              (function() {
                  var d = document, s = d.createElement('script');
                  s.src = '//blischalkblog.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
        </article>
        <footer class="footer reveal">
  <p>
    Site content by: <a href="/about" title="About me">Brett Lischalk</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  <script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>


  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-4121143-2','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>


</body>
</html>
