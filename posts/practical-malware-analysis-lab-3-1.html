<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Brett Lischalk | Practical Malware Analysis: Lab 3-1</title>
  <meta name="description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 3-1 malware.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Practical Malware Analysis: Lab 3-1">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://brettlischalk.com//posts/practical-malware-analysis-lab-3-1">
  <meta property="og:description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 3-1 malware.">
  <meta property="og:site_name" content="Brett Lischalk">
  <meta property="og:image" content="http://brettlischalk.com//assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://brettlischalk.com//posts/practical-malware-analysis-lab-3-1">
  <meta name="twitter:title" content="Practical Malware Analysis: Lab 3-1">
  <meta name="twitter:description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 3-1 malware.">
  <meta name="twitter:image" content="http://brettlischalk.com//assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://brettlischalk.com//feed.xml" type="application/rss+xml" rel="alternate" title="Brett Lischalk Last 10 blog posts" />

  
    <link type="text/css" rel="stylesheet" href="/assets/dark.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="Brett Lischalk">Brett Lischalk</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <span class="icon icon-android-person"></span>
        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/blischalk" target="_blank" title="Twitter">
          <span class="icon icon-social-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/blischalk" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/brett-lischalk-3104537" target="_blank" title="LinkedIn">
          <span class="icon icon-social-linkedin"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="mailto:brett@brettlischalk.com" target="_blank" title="Email">
          <span class="icon icon-at"></span>
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>Practical Malware Analysis: Lab 3-1</h1>
            <div class="article-list-footer">
              <span class="article-list-date">
                September 20, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  5 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/malware">malware</a>
                
                  <a href="/tag/analysis">analysis</a>
                
                  <a href="/tag/practical-malware-analysis">practical-malware-analysis</a>
                
                  <a href="/tag/reverse-engineering">reverse-engineering</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>This is my analysis of the malware for Lab03-01 from the Practical
Malware Analysis book exercises.</p>

<h2 id="overview">Overview</h2>

<p>The Lab 3-1 malware that is to be analyized using basic dynamic
analysis techniques consists of the file <code class="highlighter-rouge">Lab03-01.exe</code>.</p>

<p>The following are the tasks required to complete the lab exercise:</p>

<h2 id="analysis">Analysis</h2>

<p>To analyze the malware, basic static analysis will be performed
first. Once the information that can be gathered is exhausted, further
analysis utilizing basic dynamic analysis techniques will be
performed.</p>

<h2 id="basic-static-analysis">Basic Static Analysis</h2>

<h3 id="what-are-this-malwares-imports-and-strings">What Are This Malware’s Imports and Strings?</h3>

<h4 id="peview">PEView</h4>

<p>Using PEView we can look at what imports the executable leverages. In
doing so we see that there is not much:</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-peview.png" alt="Lab03-01.exe in PEView" /></p>

<p>The only import that seems to be used is <code class="highlighter-rouge">ExitProcess</code> from <code class="highlighter-rouge">kernel32</code>.</p>

<h4 id="ida-pro">IDA Pro</h4>

<p>Opening the executable in IDA Pro reveals the same:</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-ida.png" alt="Lab03-01.exe in PEView" /></p>

<p>This would seem to indicate that the file is packed. Our next step is
to look at the strings.</p>

<h4 id="strings">Strings</h4>

<p>Running on <code class="highlighter-rouge">strings</code> on the <code class="highlighter-rouge">Lab03-01.exe</code> reveals the following:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">strings Lab03-01.exe

<span class="o">!</span>This program cannot be run <span class="k">in </span>DOS mode.
Rich
.text
<span class="sb">`</span>.data
ExitProcess
kernel32.dll
CONNECT %s:%i HTTP/1.0
advapi32
ntdll
user32
QQVP
advpack
StubPath
SOFTWARE<span class="se">\C</span>lasses<span class="se">\h</span>ttp<span class="se">\s</span>hell<span class="se">\o</span>pen<span class="se">\c</span>ommandV
Software<span class="se">\M</span>icrosoft<span class="se">\A</span>ctive Setup<span class="se">\I</span>nstalled Components<span class="se">\</span>
<span class="nb">test
 </span>www.practicalmalwareanalysis.com
admin
VideoDriver
WinVMX32-
vmx32to64.exe
SOFTWARE<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\R</span>un
SOFTWARE<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\E</span>xplorer<span class="se">\S</span>hell Folders
AppData</code></pre></figure>

<p>Based on the amount of strings that are revealed it seems to indicate
that this executable is actually not packed. A packed executable would
normally not reveal so many strings. From the strings that are
revealed we find some interesting things:</p>

<ul>
  <li>www.practicalmalwareanalysis.com</li>
  <li>SOFTWARE\Microsoft\Windows\CurrentVersion\Run</li>
  <li>SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</li>
  <li>WinVMX32</li>
  <li>VideoDriver</li>
  <li>vmx32-to64.exe</li>
</ul>

<h2 id="basic-dynamic-analysis">Basic Dynamic Analysis</h2>

<p>Basic Dynamic Analysis begins with a bit of setup. We:</p>

<ul>
  <li>Configure and start <code class="highlighter-rouge">ApateDNS</code> on the target machine. The
configuration will resolve DNS requests to the ip of another vm
setup to pretend to be the actual server the malware would want to
connect to.</li>
  <li>Start <code class="highlighter-rouge">Process Explorer</code> on the target machine to look at dll’s and mutexes.</li>
  <li>Start and clear <code class="highlighter-rouge">Process Monitor</code> to monitor what the malware does
while executing.</li>
  <li>Start <code class="highlighter-rouge">netcat</code> listening on the honeypot vm that will be pretending to
be a real service the malware is trying to connect to.</li>
</ul>

<p>With this setup in place the malware is executed and the following
results are derived…</p>

<h3 id="apatedns">ApateDNS</h3>

<p>Within <code class="highlighter-rouge">ApateDNS</code> it is aparant that an attempt is made by the malware
to reachout to <code class="highlighter-rouge">www.practicalmalware.com</code>. This is consistent with
what was expected based on what was seen while analyzing the strings
that are utilized by the malware.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-apatedns.png" alt="Lab03-01.exe Making DNS Request" /></p>

<h3 id="process-explorer">Process Explorer</h3>

<p>Within <code class="highlighter-rouge">Process Explorer</code> we look for a couple things. We first notice
that the malware creates a <code class="highlighter-rouge">mutex</code> called <code class="highlighter-rouge">WinVMX32</code>:</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-procexplorer-mutex.png" alt="Lab03-01.exe Mutexes" /></p>

<p>Malware often creates mutexes to prevent multiple instances of the
malware from attempting to infect the same macine. If an instance of
the malware is unable to obtain a handle to the named mutex, then the
malware will exit. The existence of a particular named mutex can be
used as a host based indicator that a host is infected.</p>

<p>The next thing that can be analyzed is the <code class="highlighter-rouge">dll's</code>. Looking at the
listing of dll’s that the malware includes at runtime, we can see:</p>

<ul>
  <li><code class="highlighter-rouge">ws2_32.dll</code></li>
  <li><code class="highlighter-rouge">wshtcp_ip.dll</code></li>
</ul>

<p><code class="highlighter-rouge">ws2_32.cll</code> is the socket library used for dealing with network
connections. <code class="highlighter-rouge">wshtcp_ip.dll</code>, according to the properties, indicates
that it is a “Windows Sockets Helper DLL”. The presence of socket
dll’s indicates network activity which we already verified by the DNS
request that the malware made.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-procexplorer-dlls.png" alt="Lab03-01.exe Dll's" /></p>

<h3 id="process-monitor">Process Monitor</h3>

<p>Filtering <code class="highlighter-rouge">Process Monitor</code> to focus in on the <code class="highlighter-rouge">Lab03-01.exe</code> process
and the operations <code class="highlighter-rouge">RegSetValue</code> and <code class="highlighter-rouge">WriteFile</code>, it can be seen that
the malware modifies a registry entry and creates a file on the
filesystem.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-procmon.png" alt="Lab03-01.exe Process Monitor" /></p>

<p>Looking at the properties of the registry modification in <code class="highlighter-rouge">Processes
Explorer</code> we can see that an executable <code class="highlighter-rouge">vmx32to64.exe</code> is set to run
on startup. This is the file that is written to the filesystem by the
malware.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-registry.png" alt="Lab03-01.exe Process Monitor Registry Entry" /></p>

<p>Looking at the properties of the <code class="highlighter-rouge">WriteFile</code> operation we can see that
7,168 bytes were written to the file system. This is the same size as
<code class="highlighter-rouge">Lab03-01.exe</code>.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-moded-file-written.png" alt="Lab03-01.exe Process Monitor File Written" /></p>

<p>If we look at the checksum’s of both files we can see that they are in
fact the same file:</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-checksum1.png" alt="Lab03-01.exe Checksum 1" />
<img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-checksum2.png" alt="Lab03-01.exe Checksum 2" /></p>

<h3 id="netcat-and-wireshark">Netcat and Wireshark</h3>

<p>Observing what <code class="highlighter-rouge">netcat</code> and <code class="highlighter-rouge">wireshark</code> receive when the malware runs
reveals that a random 256 bytes appear to be sent as a
“beacon”. Malware often utilizes a beacon to let a “command and control”
server know that the malware is ready to roll.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-netcat.png" alt="Lab03-01.exe Netcat" />
<img src="/assets/PracticalMalwareAnalysis/Lab03/Lab03-01-exe-wireshark.png" alt="Lab03-01.exe Wireshark" /></p>

<h3 id="the-questions">The Questions</h3>

<h3 id="what-are-this-malwares-imports-and-strings-1">What Are This Malware’s Imports and Strings?</h3>

<p>The only import that is found is <code class="highlighter-rouge">ExitProcess</code>. A bunch of interesting
strings are found:</p>

<ul>
  <li>www.practicalmalwareanalysis.com</li>
  <li>SOFTWARE\Microsoft\Windows\CurrentVersion\Run</li>
  <li>WinVMX32</li>
  <li>VideoDriver</li>
  <li>vmx32-to64.exe</li>
</ul>

<p>Through our basic dynamic analysis we learn that these are all used by
the malware during execution. <code class="highlighter-rouge">www.practicalmalwareanalysis.com</code> is
where the malware phone’s home
to. <code class="highlighter-rouge">SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code> is the registry
entry that is used to start the malware on system start. <code class="highlighter-rouge">WinVMX32</code> is
the name of the mutex that is created to prevent multiple instances of
the malware from infecting the same computer. <code class="highlighter-rouge">VideoDriver</code> is the
registry entry key that is used. <code class="highlighter-rouge">vmx32-to64.exe</code> is the malware that
gets written and started at system startup.</p>

<h3 id="what-are-the-malwares-host-based-indicators">What Are The Malware’s Host-Based Indicators?</h3>

<p>Host based indicators include:</p>

<ul>
  <li>A mutex called <code class="highlighter-rouge">WinVMX32</code></li>
  <li>The presence of <code class="highlighter-rouge">vmx32-to64.exe</code> in <code class="highlighter-rouge">C:\WINDOWS\system32</code></li>
  <li>A registry entry of <code class="highlighter-rouge">VideoDriver</code></li>
</ul>

<h3 id="are-there-any-useful-network-based-signatures-for-this-malware-if-so-what-are-they">Are There Any Useful Network-Based Signatures for This Malware? If So, What Are They?</h3>

<p>I am not sure that there are network-based “signatures” of the malware
as the requests include random bytes. A network based indicator that
the malware is present would be requests being made to
<code class="highlighter-rouge">www.practicalmalwareanalysis.com</code>.</p>

          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=Practical Malware Analysis: Lab 3-1 - http://brettlischalk.com//posts/practical-malware-analysis-lab-3-1 by @blischalk', 'newwindow', 'width=500, height=225'); return false;">
              <span class="icon icon-social-twitter"></span>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://brettlischalk.com//posts/practical-malware-analysis-lab-3-1', 'newwindow', 'width=500, height=500'); return false;">
              <span class="icon icon-social-facebook"></span>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=http://brettlischalk.com//posts/practical-malware-analysis-lab-3-1', 'newwindow', 'width=550, height=400'); return false;">
              <span class="icon icon-social-googleplus"></span>
            </a>
          </div>

          <a href="https://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/" title="Offensive Security Certified Professional" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-oscp.png" />
          </a>
          <a href="https://www.offensive-security.com/information-security-certifications/osce-offensive-security-certified-expert/" title="Offensive Security Certified Expert" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-osce.png"" />
          </a>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script>
              (function() {
                  var d = document, s = d.createElement('script');
                  s.src = '//blischalkblog.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
        </article>
        <footer class="footer reveal">
  <p>
    Site content by: <a href="/about" title="About me">Brett Lischalk</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  <script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>


  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-4121143-2','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>


</body>
</html>
