<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Brett Lischalk | Practical Malware Analysis: Lab 1-4</title>
  <meta name="description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 1-4 malware.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Practical Malware Analysis: Lab 1-4">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://localhost:4000/posts/practical-malware-analysis-lab-1-4">
  <meta property="og:description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 1-4 malware.">
  <meta property="og:site_name" content="Brett Lischalk">
  <meta property="og:image" content="http://localhost:4000/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://localhost:4000/posts/practical-malware-analysis-lab-1-4">
  <meta name="twitter:title" content="Practical Malware Analysis: Lab 1-4">
  <meta name="twitter:description" content="Walkthrough of the processes followed to analyze the Practical Malware Analysis Lab 1-4 malware.">
  <meta name="twitter:image" content="http://localhost:4000/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://localhost:4000/feed.xml" type="application/rss+xml" rel="alternate" title="Brett Lischalk Last 10 blog posts" />

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6246123062809579",
      enable_page_level_ads: true
    });
  </script>

  
    <link type="text/css" rel="stylesheet" href="/assets/dark.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="Brett Lischalk">Brett Lischalk</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <span class="icon icon-android-person"></span>
        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/blischalk" target="_blank" title="Twitter">
          <span class="icon icon-social-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/blischalk" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/brett-lischalk-3104537" target="_blank" title="LinkedIn">
          <span class="icon icon-social-linkedin"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="mailto:brett@brettlischalk.com" target="_blank" title="Email">
          <span class="icon icon-at"></span>
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>Practical Malware Analysis: Lab 1-4</h1>
            <div class="article-list-footer">
              <span class="article-list-date">
                August 28, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  4 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/malware">malware</a>
                
                  <a href="/tag/analysis">analysis</a>
                
                  <a href="/tag/practical-malware-analysis">practical-malware-analysis</a>
                
                  <a href="/tag/reverse-engineering">reverse-engineering</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>This is my analysis of the malware for Lab01-04 from the Practical
Malware Analysis book exercises.</p>

<h2 id="overview">Overview</h2>

<p>The Lab 1-4 malware that is to be analyized using basic static
analysis techniques consists of the file <code class="highlighter-rouge">Lab01-04.exe</code>.</p>

<p>The following are the tasks required to complete the lab exercise:</p>

<h2 id="basic-static-analysis">Basic Static Analysis</h2>

<h3 id="virustotal">VirusTotal?</h3>

<p>Upload the Lab01-04.exe file to
<a href="http://www.virustotal.com">http://www.virustotal.com</a>. Does it match
any existing antivirus definitions?</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-04-exe-virus-total.png" alt="Lab01-04.exe Virus Total" /></p>

<p>According to VirusTotal, this malware does match existing antivirus definitions.</p>

<h3 id="packed-or-obfuscated">Packed or Obfuscated?</h3>

<p>Are there any indications that this file is packed or obfuscated? If
so, what are these indicators? If the file is packed, unpack it if
possible.</p>

<h4 id="strings">Strings</h4>

<p>Running strings on the executable yields:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">PS C:<span class="se">\U</span>sers<span class="se">\B</span>rett<span class="se">\D</span>esktop<span class="se">\P</span>ractical Malware Analysis Labs<span class="se">\B</span>inaryCollection<span class="se">\C</span>hapter_1L&gt; strings .<span class="se">\L</span>ab01-04.exe

Strings v2.53 - Search <span class="k">for </span>ANSI and Unicode strings <span class="k">in </span>binary images.
Copyright <span class="o">(</span>C<span class="o">)</span> 1999-2016 Mark Russinovich
Sysinternals - www.sysinternals.com

<span class="o">!</span>This program cannot be run <span class="k">in </span>DOS mode.

.. snip ..
Rich
.text
<span class="sb">`</span>.rdata
@.data
.rsrc
CloseHandle
OpenProcess
GetCurrentProcess
CreateRemoteThread
GetProcAddress
LoadLibraryA
WinExec
WriteFile
CreateFileA
SizeofResource
LoadResource
FindResourceA
GetModuleHandleA
GetWindowsDirectoryA
MoveFileA
GetTempPathA
KERNEL32.dll
AdjustTokenPrivileges
LookupPrivilegeValueA
OpenProcessToken
ADVAPI32.dll
_snprintf
MSVCRT.dll
_exit
_XcptFilter
<span class="nb">exit
</span>__p___initenv
__getmainargs
_initterm
__setusermatherr
_adjust_fdiv
__p__commode
__p__fmode
__set_app_type
_except_handler3
_controlfp
_stricmp
winlogon.exe
&lt;not real&gt;
SeDebugPrivilege
sfc_os.dll
<span class="se">\s</span>ystem32<span class="se">\w</span>updmgr.exe
%s%s
BIN
<span class="c">#101</span>
EnumProcessModules
psapi.dll
GetModuleBaseNameA
psapi.dll
EnumProcesses
psapi.dll
<span class="se">\s</span>ystem32<span class="se">\w</span>updmgr.exe
%s%s
<span class="se">\w</span>inup.exe
%s%s
BIN
<span class="o">!</span>This program cannot be run <span class="k">in </span>DOS mode.
Rich
.text
<span class="sb">`</span>.rdata
@.data

.. snip ..

GetWindowsDirectoryA
WinExec
GetTempPathA
KERNEL32.dll
URLDownloadToFileA
urlmon.dll
_snprintf
MSVCRT.dll
_exit
_XcptFilter
<span class="nb">exit
</span>__p___initenv
__getmainargs
_initterm
__setusermatherr
_adjust_fdiv
__p__commode
__p__fmode
__set_app_type
_except_handler3
_controlfp
<span class="se">\w</span>inup.exe
%s%s
<span class="se">\s</span>ystem32<span class="se">\w</span>updmgrd.exe
%s%s
http://www.practicalmalwareanalysis.com/updater.exe</code></pre></figure>

<p>We can see that there is actually quite a bit of information found by
using the strings application. It is probably safe to say that this is
not packed or obfuscated. Let’s check out IDApro just to be safe.</p>

<h4 id="idapro">IDAPro</h4>

<p>IDAPro has no issues loading the file so no alerts of packing or
obfuscation are given. The instructions that are outlined seem to be
very clear as it can bee seen which libraries are getting loaded and
which functions are getting called.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-04-exe-idapro.png" alt="Lab01-04.exe IDAPro" /></p>

<p>At this point I’m convinced that this is not packed or obfuscated.</p>

<h3 id="imports-hint-at-functionality">Imports Hint at Functionality?</h3>

<p>The imports indicate a few things:</p>

<ul>
  <li><code class="highlighter-rouge">LoadResource, FindResource, and SizeOfResource</code> indicate that data
is loaded from the resource section</li>
  <li><code class="highlighter-rouge">GetWindowsDirectory</code> indicates that files may be written to the
system directory</li>
  <li><code class="highlighter-rouge">WinExec</code> indicates that a program gets executed</li>
  <li><code class="highlighter-rouge">CreateFile</code> and <code class="highlighter-rouge">WriteFile</code> indicate that a file gets created and written to</li>
  <li><code class="highlighter-rouge">URLDownloadToFileA</code> points at something being downloaded to a file</li>
  <li><code class="highlighter-rouge">EnumProcesses</code> gets an array of process ids</li>
  <li><code class="highlighter-rouge">SeDebugPrivilege</code> indicates that this malware may inject code into
another process it doesn’t own</li>
</ul>

<h3 id="host--or-network-based-indicators">Host- or Network-Based Indicators?</h3>

<p>For host based indicators the following files could indicate that the
host is infected:</p>

<ul>
  <li><code class="highlighter-rouge">\winup.exe</code></li>
  <li><code class="highlighter-rouge">\system32\wupdmgrd.exe</code></li>
  <li><code class="highlighter-rouge">\system32\wupdmgr.exe</code></li>
</ul>

<p>Network activity to
<code class="highlighter-rouge">http://www.practicalmalwareanalysis.com/updater.exe</code> could be a
network based indicator that this malware is present.</p>

<h3 id="bonus-round-resource-section">Bonus Round: Resource Section</h3>

<p>Because the imports seem to indicate that something is loaded from the
resource section, Resource Hacker can be used to see what may live
there:</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-04-exe-resource-hacker.png" alt="Lab01-04.exe ResourceHacker" /></p>

<p>The string we found earlier “!This program cannot be run in DOS mode.”
appears to indicate that this binary is actually another executable
living in the resource section. Saving this as a binary lets analyze
it just like any other executable.</p>

<p><img src="/assets/PracticalMalwareAnalysis/Lab01/Lab01-04-exe-idapro-2.png" alt="Lab01-04.exe IDAPro 2" /></p>

<p>Viewing the executable in IDAPro we can see the instructions that it
tries to perform. In this particular screenshot, we can see it
attempting to call out to
<code class="highlighter-rouge">http://www.practicalmalwareanalysis.com/updater.exe</code>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This malware was particularly interesting because of its use of the
resource section to contain another executable. I’m not 100% sure what
the advantage of doing something like this might be but upon thinking
about it a bit more, I think that by organizing the malware in this
way, the particularly malicious parts of the malware don’t appear on
the system right away. They show up after the downloader portion is
extracted from the resource section of the executable and downloads
the main payload, adding 2 layers of obfuscation as to what the
malware’s true intentions might be. I wonder what sort of tricks the
next lab will hold…</p>

          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=Practical Malware Analysis: Lab 1-4 - http://localhost:4000/posts/practical-malware-analysis-lab-1-4 by @blischalk', 'newwindow', 'width=500, height=225'); return false;">
              <span class="icon icon-social-twitter"></span>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/posts/practical-malware-analysis-lab-1-4', 'newwindow', 'width=500, height=500'); return false;">
              <span class="icon icon-social-facebook"></span>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=http://localhost:4000/posts/practical-malware-analysis-lab-1-4', 'newwindow', 'width=550, height=400'); return false;">
              <span class="icon icon-social-googleplus"></span>
            </a>
          </div>

          <a href="https://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/" title="Offensive Security Certified Professional" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-oscp.png" />
          </a>
          <a href="https://www.offensive-security.com/information-security-certifications/osce-offensive-security-certified-expert/" title="Offensive Security Certified Expert" target="_blank">
            <img src="/assets/offsec-student-certified-emblem-rgb-osce.png"" />
          </a>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script>
              (function() {
                  var d = document, s = d.createElement('script');
                  s.src = '//blischalkblog.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
        </article>
        <footer class="footer reveal">
  <p>
    Site content by: <a href="/about" title="About me">Brett Lischalk</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  <script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>


  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-4121143-2','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>


</body>
</html>
